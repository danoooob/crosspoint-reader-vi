name: Compile Prerelease
on:
  workflow_dispatch:
    inputs:
      prerelease_tag:
        description: 'Tag name override (leave empty for auto-generated: <version>-<branch>-YYMMDDhhmm)'
        required: false
        type: string
        default: ''

jobs:
  build-prerelease:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0
          submodules: recursive
      - uses: actions/cache@v5
        with:
          path: |
            ~/.cache/pip
            ~/.platformio/.cache
          key: ${{ runner.os }}-pio
      - uses: actions/setup-python@v6
        with:
          python-version: '3.14'

      - name: Install PlatformIO Core
        run: pip install --upgrade platformio

      - name: Generate tag name
        id: tag
        run: |
          VERSION=$(grep -A1 '\[crosspoint\]' platformio.ini | grep -oP 'version\s*=\s*\K[0-9.]+')
          BRANCH=${GITHUB_REF_NAME}
          TIMESTAMP=$(date -u +'%y%m%d%H%M')
          if [ -n "${{ inputs.prerelease_tag }}" ]; then
            TAG_NAME="${{ inputs.prerelease_tag }}"
          else
            TAG_NAME="${VERSION}-${BRANCH}-${TIMESTAMP}"
          fi
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "release_name=v${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "Generated tag: ${TAG_NAME}"
          
          # Find previous prerelease tag from this branch for changelog
          PREV_TAG=$(git tag --list "*-${BRANCH}-*" --sort=-version:refname | head -n 1)
          if [ -n "$PREV_TAG" ]; then
            echo "prev_tag=${PREV_TAG}" >> $GITHUB_OUTPUT
            echo "Previous prerelease tag: ${PREV_TAG}"
          else
            echo "prev_tag=" >> $GITHUB_OUTPUT
            echo "No previous prerelease tag found"
          fi

      - name: Build CrossPoint (prerelease)
        run: pio run -e gh_prerelease
        env:
          PRERELEASE_VERSION: ${{ steps.tag.outputs.tag_name }}

      - name: Create Prerelease
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag_name }}
          name: Prerelease ${{ steps.tag.outputs.release_name }}
          prerelease: true
          generate_release_notes: false
          body: |
            > [!WARNING]
            > **This is an experimental prerelease from the `${{ github.ref_name }}` branch.**
            >
            > - This build contains experimental features and customizations.
            > - Some code is AI-generated and may not be fully optimized or thoroughly tested.
            > - **For regular use, please use the [official releases](https://github.com/daveallie/crosspoint-reader/releases) from the upstream repository.**
            >
            > Use at your own risk. This prerelease is intended for testing purposes only.

            ---
            
            **Full Changelog**: ${{ steps.tag.outputs.prev_tag != '' && format('https://github.com/{0}/compare/{1}...{2}', github.repository, steps.tag.outputs.prev_tag, steps.tag.outputs.tag_name) || format('https://github.com/{0}/commits/{1}', github.repository, github.ref_name) }}

          files: |
            .pio/build/gh_prerelease/firmware.bin
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}